<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Embedding external functions in GGIR • GGIR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Embedding external functions in GGIR">
<script defer data-domain="pkgdown.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">GGIR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.1-6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-the-book" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">The book</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-the-book">
<li><a class="dropdown-item" href="../articles/chapter1_WhatIsGGIR.html">1. What is GGIR</a></li>
    <li><a class="dropdown-item" href="../articles/chapter2_Pipeline.html">2. The GGIR Pipeline</a></li>
    <li><a class="dropdown-item" href="../articles/chapter3_QualityAssessment.html">3. Data Quality Assurance</a></li>
    <li><a class="dropdown-item" href="../articles/chapter4_AccMetrics.html">4. From Raw Data to Acceleration Metrics</a></li>
    <li><a class="dropdown-item" href="../articles/chapter5_StudyProtocol.html">5. Accounting for Study Protocol</a></li>
    <li><a class="dropdown-item" href="../articles/chapter6_DataImputation.html">6. How GGIR Deals with Invalid Data</a></li>
    <li><a class="dropdown-item" href="../articles/chapter7_DescribingDataWithoutKnowingSleep.html">7. Describing the Data Without Knowing Sleep</a></li>
    <li><a class="dropdown-item" href="../articles/chapter8_SleepFundamentalsSibs.html">8. Sleep Fundamentals - Sustained Inactivity Bout Detection (SIB)</a></li>
    <li><a class="dropdown-item" href="../articles/chapter9_SleepFundamentalsGuiders.html">9. Sleep Fundamentals - Guiding Sleep Detection</a></li>
    <li><a class="dropdown-item" href="../articles/chapter10_SleepAnalysis.html">10. Sleep Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/chapter11_DescribingDataCutPoints.html">11. Physical Activity Fundamentals - Describing the data with cut-points</a></li>
    <li><a class="dropdown-item" href="../articles/chapter12_TimeUseAnalysis.html">12. Time-Use Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/chapter13_CircadianRhythm.html">13. Circadian Rhythm Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/chapter14_BehaviouralFragmentation.html">14. Behavioural Fragmentation</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-annexes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Annexes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-annexes">
<li><a class="dropdown-item" href="../articles/GGIRParameters.html">GGIR Parameters</a></li>
    <li><a class="dropdown-item" href="../articles/GGIRoutput.html">GGIR Output</a></li>
    <li><a class="dropdown-item" href="../articles/readmyacccsv.html">Reading csv files with raw data</a></li>
    <li><a class="dropdown-item" href="../articles/ExternalFunction.html">Embedding external functions in GGIR</a></li>
    <li><a class="dropdown-item" href="../articles/CutPoints.html">Published cut-points and how to use them</a></li>
    <li><a class="dropdown-item" href="../articles/TutorialDaySegmentAnalyses.html">Day-segment analyses</a></li>
    <li><a class="dropdown-item" href="../articles/HouseHoldCoanalysis.html">Household co-analysis</a></li>
    <li><a class="dropdown-item" href="../articles/Cookbook.html">Cookbook</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/chapter0_Installation.html">Installation</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/chapter0_GetStarted.html">Get started</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.accelting.com/updates/ggir-release-3-1-0/">Version 3.1-0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.accelting.com/updates/ggir-release-3-0-0/">Version 3.0-0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.accelting.com/updates/ggir-release-2-9-0/">Version 2.9-0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.accelting.com/updates/ggir-release-2-8-0/">Version 2.8-0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.accelting.com/updates/ggir-release-2-7-1/">Version 2.7-1</a></li>
    <li><a class="external-link dropdown-item" href="https://www.accelting.com/updates/ggir-release-2-6-0/">Version 2.6-0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.accelting.com/updates/ggir-release-2-5-0/">Version 2.5-0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/chapter0_Contributing.html">Contributing</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/chapter0_Support.html">Need help?</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/wadpac/GGIR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/RpackageGGIR" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Embedding external functions in GGIR</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/wadpac/GGIR/blob/HEAD/vignettes/ExternalFunction.Rmd" class="external-link"><code>vignettes/ExternalFunction.Rmd</code></a></small>
      <div class="d-none name"><code>ExternalFunction.Rmd</code></div>
    </div>

    
    
<p><strong>NOTE: If you are viewing this page via CRAN note that
additional documentation can be found in the <a href="https://wadpac.github.io/GGIR/">GGIR GitHub
pages</a>.</strong></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>If you like GGIR but want to use algorithms for raw data not included
in GGIR then the external function embedding feature can be the
solution. For example, you may want to pilot a new machine learned
classifiction algorithm but you do not want to write all the data
cleaning and aggregation steps needed for analysis of real life ‘out of
the lab’ acceleormeter data.</p>
<p><strong>How it works:</strong></p>
<p>Internally GGIR loads the raw accelerometer data in memory blocks of
about 24 hours. When the data is in memory, corrected for calibration
error, and resampled to the sample rate required by your function, GGIR
applies its own default algorithms as well as the external function
provided by you (Python or R). The external function is expected to take
as input: A three-column matrix with the acceleration data corresponding
to the three acceleration axes, and an optional parameters argument
which can be of any R format (character, list, vector, data.frame, etc).
As output your external function is expected to produce a matrix or
data.frame with one or multiple columns corresponding to the output of
your external function.</p>
</div>
<div class="section level2">
<h2 id="example-with-external-r-function">Example with external R function<a class="anchor" aria-label="anchor" href="#example-with-external-r-function"></a>
</h2>
<p>In this example we will apply the function counts() from R package <a href="https://CRAN.R-project.org/package=activityCounts" class="external-link">activityCounts</a>
to the raw data, which produces an estimate of Actigraph counts per
second.</p>
<div class="section level3">
<h3 id="write-external-function">Write external function<a class="anchor" aria-label="anchor" href="#write-external-function"></a>
</h3>
<p>Create file <strong>calculateCounts.R</strong> and insert the
following code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calculateCounts</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">parameters</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># data: 3 column matrix with acc data</span></span>
<span>  <span class="co"># parameters: the sample rate of data</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/walkabillylab/activityCounts" class="external-link">"activityCounts"</a></span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span> <span class="va">data</span><span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span>  <span class="va">mycounts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/activityCounts/man/counts.html" class="external-link">counts</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">data</span>, hertz<span class="op">=</span><span class="va">parameters</span>, </span>
<span>                    x_axis<span class="op">=</span><span class="fl">1</span>, y_axis<span class="op">=</span><span class="fl">2</span>, z_axis<span class="op">=</span><span class="fl">3</span>,</span>
<span>                    start_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mycounts</span> <span class="op">=</span> <span class="va">mycounts</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="co">#Note: do not provide timestamps to GGIR</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mycounts</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="provide-external-function-to-ggir">Provide external function to GGIR<a class="anchor" aria-label="anchor" href="#provide-external-function-to-ggir"></a>
</h3>
<p>Create a new .R file for running the GGIR analysis, e.g. named
<code>myscript.R</code>, and insert the following code. Do not forget to
update the filepath on the first line to point to your
<code>calculateCounts.R</code> file.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"~/calculateCounts.R"</span><span class="op">)</span></span>
<span><span class="va">myfun</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>FUN<span class="op">=</span><span class="va">calculateCounts</span>,</span>
<span>              parameters<span class="op">=</span> <span class="fl">30</span>,</span>
<span>              expected_sample_rate<span class="op">=</span> <span class="fl">30</span>,</span>
<span>              expected_unit<span class="op">=</span><span class="st">"g"</span>,</span>
<span>              colnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"countsX"</span>,<span class="st">"countsY"</span>,<span class="st">"countsZ"</span><span class="op">)</span>,</span>
<span>              outputres <span class="op">=</span> <span class="fl">1</span>,</span>
<span>              minlength <span class="op">=</span> <span class="fl">1</span>,</span>
<span>              outputtype<span class="op">=</span><span class="st">"numeric"</span>,</span>
<span>              aggfunction <span class="op">=</span> <span class="va">sum</span>,</span>
<span>              timestamp<span class="op">=</span><span class="cn">F</span>,</span>
<span>              reporttype<span class="op">=</span><span class="st">"scalar"</span><span class="op">)</span></span></code></pre></div>
<p>The above code creates object <code>myfun</code> of type
<code>list</code> which is expected to come with the following
elements:</p>
<ul>
<li>
<code>FUN</code> A character string specifying the location of the
external function you want to apply.</li>
<li>
<code>parameters</code> The parameters used by the function, which
can be stored in any format (vector, matrix, list, data.frame). The user
should make sure that the external function can handle this object.</li>
<li>
<code>expected_sample_rate</code> Expected sample rate, if the
inputdata has a difference sample rate, then the data will be
resampled.</li>
<li>
<code>expected_unit</code> Expected unit of the acceleration by
external function: “mg”, “g” or “ms2”. If input data is different it
will be converted.</li>
<li>
<code>colnames</code> Character vector with the names of the columns
produced by the external function.</li>
<li>
<code>outputres</code> The resolution (seconds) of the output
produced by the external function. Note, that this needs to be equal to
or a multitude of the short epoch size of the g.part1 output (5 seconds)
or the short epoch size should be a multitude of this resolution. In
this way GGIR can aggregate or repeat the external function output to be
used inside GGIR.</li>
<li>
<code>minlength</code> The minimum length (seconds) of input data
needed, typically the window per which output is provided.</li>
<li>
<code>outputtype</code> Character to indicate the type of external
function output. Set to “numeric” if data is stored in numbers (any
numeric format), or “character” if it is a character string.</li>
<li>
<code>aggfunction</code> If the data needs to be aggregated to match
the short epoch size of the g.part1 output (5 seconds) then this element
specifies what function should be used for the aggregation, e.g. mean,
sum, median.</li>
<li>
<code>timestamp</code> Boolean to indicated whether timestamps
(seconds since 1-1-1970) should be passed on to the external function as
first columm of the data matrix..</li>
<li>
<code>reporttype</code> Character to indicate the type of reporting
by GGIR: “scalar” if it should be averaged per day, “event” if it should
be summed per day, or “type” if it is categorical variable that can only
be aggregated per day by tabulating it.</li>
</ul>
<p>Next, add a call to GGIR function GGIR with <code>myfun</code>
provided as one of its arguments:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wadpac/GGIR/" class="external-link">GGIR</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/GGIR.html">GGIR</a></span><span class="op">(</span>datadir<span class="op">=</span><span class="st">"~/myaccelerometerdata"</span>,</span>
<span>             outputdir<span class="op">=</span><span class="st">"~/myresults"</span>,</span>
<span>             mode<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>             epochvalues2csv <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>             do.report<span class="op">=</span><span class="fl">2</span>,</span>
<span>             myfun<span class="op">=</span><span class="va">myfun</span><span class="op">)</span> <span class="co">#&lt;= this is where object myfun is provided to GGIR</span></span></code></pre></div>
<p>Please see the <a href="https://cran.r-project.org/package=GGIR/vignettes/GGIR.html" class="external-link"></a>
for more information about function GGIR.</p>
</div>
</div>
<div class="section level2">
<h2 id="example-with-external-python-function">Example with external Python function<a class="anchor" aria-label="anchor" href="#example-with-external-python-function"></a>
</h2>
<p>In this example we will use an external Python function to estimate
the dominant signal frequency per acceleration axis. Note this can also
be done in R, but it shows that even Python functions can be
provided.</p>
<div class="section level3">
<h3 id="write-external-function-1">Write external function<a class="anchor" aria-label="anchor" href="#write-external-function-1"></a>
</h3>
<p>Create <strong>dominant_frequency.py</strong> and insert the code
shown below:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="kw">def</span> dominant_frequency(x, sf):</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="co"># x: vector with data values</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="co"># sf: sample frequency</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  fourier <span class="op">=</span> numpy.fft.fft(x)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  frequencies <span class="op">=</span> numpy.fft.fftfreq(<span class="bu">len</span>(x), <span class="dv">1</span><span class="op">/</span>sf)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>  magnitudes <span class="op">=</span> <span class="bu">abs</span>(fourier[numpy.where(frequencies <span class="op">&gt;</span> <span class="dv">0</span>)])</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  peak_frequency <span class="op">=</span> frequencies[numpy.argmax(magnitudes)]</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="cf">return</span> peak_frequency</span></code></pre></div>
<p>Create <strong>dominant_frequency.R</strong> that calls the python
function and insert the following code:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>dominant_frequency <span class="ot">=</span> <span class="cf">function</span>(<span class="at">data=</span><span class="fu">c</span>(), <span class="at">parameters=</span><span class="fu">c</span>()) {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  <span class="co"># data: 3 column matrix with acc data</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="co"># parameters: the sample rate of data</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="fu">source_python</span>(<span class="st">"dominant_frequency.py"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  sf<span class="ot">=</span>parameters</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">nrow</span>(data)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  ws <span class="ot">=</span> <span class="dv">5</span> <span class="co"># windowsize</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">ncol</span>(data) <span class="sc">==</span> <span class="dv">4</span>) data<span class="ot">=</span> data[,<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">t=</span> <span class="fu">floor</span>(<span class="fu">seq</span>(<span class="dv">0</span>,(N<span class="dv">-1</span>)<span class="sc">/</span>sf,<span class="at">by=</span><span class="dv">1</span><span class="sc">/</span>sf)<span class="sc">/</span>ws),</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>                    <span class="at">x=</span>data[,<span class="dv">1</span>], <span class="at">y=</span>data[,<span class="dv">2</span>], <span class="at">z=</span>data[,<span class="dv">3</span>])</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>  df <span class="ot">=</span> <span class="fu">aggregate</span>(data, <span class="at">by =</span> <span class="fu">list</span>(data<span class="sc">$</span>t), </span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>                 <span class="at">FUN=</span><span class="cf">function</span>(x) {<span class="fu">return</span>(<span class="fu">dominant_frequency</span>(x,sf))})</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  df <span class="ot">=</span> df[,<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>}</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="provide-external-function-to-ggir-1">Provide external function to GGIR<a class="anchor" aria-label="anchor" href="#provide-external-function-to-ggir-1"></a>
</h3>
<p>Create a new .R file for running the GGIR analysis, e.g. named
myscript.R, and insert the following blocks of code.</p>
<p>Specification of Python environment to use, this can also be a conda
environment or docker container (see documentation R package <a href="https://rstudio.github.io/reticulate/" class="external-link"></a> for further details).
Make sure that that this Python environment has all the required
dependencies for the external function, here we will only need
<code>numpy</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://rstudio.github.io/reticulate/" class="external-link">"reticulate"</a></span><span class="op">)</span></span>
<span>  <span class="fu">use_virtualenv</span><span class="op">(</span><span class="st">"~/myvenv"</span>, required <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Local Python environment</span></span>
<span>  <span class="fu">py_install</span><span class="op">(</span><span class="st">"numpy"</span>, pip <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Specify a <code>myfun</code> object as explained in the R example. Do
not forget to update the filepath to the
<code>"~/dominant_frequency.R"</code> file.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/dominant_frequency.R"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>myfun <span class="ot">=</span>  <span class="fu">list</span>(<span class="at">FUN=</span>dominant_frequency,</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>              <span class="at">parameters=</span> <span class="dv">30</span>,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>              <span class="at">expected_sample_rate=</span> <span class="dv">30</span>,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>              <span class="at">expected_unit=</span><span class="st">"g"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>              <span class="at">colnames =</span> <span class="fu">c</span>(<span class="st">"domfreqX"</span>, <span class="st">"domfreqY"</span>, <span class="st">"domfreqZ"</span>),</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>              <span class="at">minlength =</span> <span class="dv">5</span>,</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>              <span class="at">outputres =</span> <span class="dv">5</span>,</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>              <span class="at">outputtype=</span><span class="st">"numeric"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>              <span class="at">aggfunction =</span> median</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>              <span class="at">timestamp=</span>F,</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>              <span class="at">reporttype=</span><span class="st">"scalar"</span>)</span></code></pre></div>
<p>Add a call to function GGIR where <code>myfun</code> is provided as
argument. Note that, do.parallel is set to FALSE. Unfortunately Python
embedding with R package reticulate and multi-threading with R package
foreach as used in GGIR do not combine well.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wadpac/GGIR/" class="external-link">GGIR</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/GGIR.html">GGIR</a></span><span class="op">(</span>datadir<span class="op">=</span><span class="st">"~/myaccelerometerdata"</span>,</span>
<span>             outputdir<span class="op">=</span><span class="st">"~/myresults"</span>,</span>
<span>             mode<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>             epochvalues2csv <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>             do.report<span class="op">=</span><span class="fl">2</span>,</span>
<span>             myfun<span class="op">=</span><span class="va">myfun</span>,</span>
<span>             do.parallel <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="integration-in-ggir-output">Integration in GGIR output<a class="anchor" aria-label="anchor" href="#integration-in-ggir-output"></a>
</h2>
<div class="section level3">
<h3 id="part-1">Part 1<a class="anchor" aria-label="anchor" href="#part-1"></a>
</h3>
<p>The external function output is included in the time series produced
by function GGIR function g.part1 and stored in an RData-file in
<code>/output_nameofstudy/meta/basic</code>. The resolution of these
output in GGIR is set by GGIR argument <code>windowsizes</code>, which
is <code>c(5,900,3600)</code> by default. Here, the first element
<code>5</code> specifies the short epoch size in seconds. If the output
of the external function is less then this resolution it will be
aggregated with the function as specificied by aggfunction in the
<code>myfun</code> object. In the count example we used the sum for this
and for the dominant frequency example we used the median.</p>
</div>
<div class="section level3">
<h3 id="part-2">Part 2<a class="anchor" aria-label="anchor" href="#part-2"></a>
</h3>
<p>Next, in part2 GGIR aims to detect non-wear periods and imputes
those. The impute time series can be found in the part 2 milestone data
in folder: <code>/output_nameofstudy/meta/ms2.out</code>. If you want
these to be directly stored in a csv file then set argument
<code>epochvalues2csv = TRUE</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="external-functions-released-by-ggir-collaborators">External functions released by GGIR collaborators:<a class="anchor" aria-label="anchor" href="#external-functions-released-by-ggir-collaborators"></a>
</h2>
<ul>
<li>Wrist-based step detection algorithm: <a href="https://github.com/ShimmerEngineering/Verisense-Toolbox/tree/master/Verisense_step_algorithm" class="external-link uri">https://github.com/ShimmerEngineering/Verisense-Toolbox/tree/master/Verisense_step_algorithm</a>
</li>
<li>Wrist-based sleep classification as described by Sundararajan et
al. 2021 <a href="https://www.nature.com/articles/s41598-020-79217-x" class="external-link">link to
paper</a>, and corresponding code is here: <a href="https://github.com/wadpac/Sundararajan-SleepClassification-2021/tree/master/ggir_ext" class="external-link uri">https://github.com/wadpac/Sundararajan-SleepClassification-2021/tree/master/ggir_ext</a>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Vincent T van Hees, Jairo H Migueles, Medical Research Council UK, Accelting, French National Research Agency.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
